name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node 18
        uses: actions/setup-node@v4
        with:
          node-version: 18


      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install Flutter deps
        run: flutter pub get

      - name: Run unit tests
        run: |
          echo "Flutter version and doctor"
          flutter --version
          flutter doctor -v
          echo "Running unit tests"
          flutter test --coverage -r expanded

      # Optional: run emulators and integration tests (commented by default)
      - name: Set up Java (for Firestore emulator)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Firebase CLI
        run: curl -sL https://firebase.tools | bash

      - name: Prepare Functions (install deps & build)
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "Preparing functions: install deps and build"
          cd "$GITHUB_WORKSPACE/functions"

          set -o pipefail
          npm ci --no-audit --no-fund --legacy-peer-deps 2>&1 | tee npm-ci.log || (echo "npm ci failed, falling back to npm install" && npm install --no-audit --no-fund --legacy-peer-deps 2>&1 | tee npm-install.log)

          ls -la node_modules || true
          [ -f npm-ci.log ] && cat npm-ci.log || true
          [ -f npm-install.log ] && cat npm-install.log || true

          npm run build

      - name: Start Firebase emulators (functions + firestore)
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "Verifying functions build output before starting emulators"
          echo "functions/package.json:" && cat "$GITHUB_WORKSPACE/functions/package.json"
          if [ ! -f "$GITHUB_WORKSPACE/functions/lib/index.js" ]; then
            echo "ERROR: functions/lib/index.js missing; build did not produce output. Listing files:" && ls -la "$GITHUB_WORKSPACE/functions" || true
            exit 1
          fi

          firebase emulators:start --only functions,firestore &
          # Give emulators a moment to start up
          sleep 5
          echo "Listing functions build output:"
          ls -la "$GITHUB_WORKSPACE/functions/lib" || true

      - name: Run integration tests (emulator)
        run: flutter test test/integration/ride_integration_test.dart -r expanded

  emulator-tests:
    name: Emulator tests (Firestore rules + Functions)
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 30
    env:
      GCLOUD_PROJECT: demo-no-project
      FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java (required by Firestore emulator)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Firebase CLI
        run: curl -sL https://firebase.tools | bash

      - name: Prepare Functions (install deps & build)
        run: |
          echo "Preparing functions: install deps and build"
          echo "Node: $(node --version)"; echo "npm: $(npm --version)"
          cd "$GITHUB_WORKSPACE/functions"

          # Prefer a clean CI install, but fall back to `npm install` if lockfile mismatches
          set -o pipefail
          npm ci --no-audit --no-fund --legacy-peer-deps 2>&1 | tee npm-ci.log || (echo "npm ci failed, falling back to npm install" && npm install --no-audit --no-fund --legacy-peer-deps 2>&1 | tee npm-install.log)

          # Show what we installed for diagnostics
          ls -la node_modules || true
          [ -f npm-ci.log ] && cat npm-ci.log || true
          [ -f npm-install.log ] && cat npm-install.log || true

          # Capture build output for diagnostics
          npm run build 2>&1 | tee build.log

          echo "Checking functions build output"
          if [ ! -f "$GITHUB_WORKSPACE/functions/lib/index.js" ]; then
            echo "ERROR: functions/lib/index.js missing after build. Listing functions dir:" && ls -la "$GITHUB_WORKSPACE/functions" || true
            echo "Listing functions/lib contents:" && ls -la "$GITHUB_WORKSPACE/functions/lib" || true
            echo "Searching for index.js files in repo:" && find "$GITHUB_WORKSPACE/functions" -maxdepth 3 -type f -name 'index.js' -ls || true
            echo "Build log (last 200 lines):" && tail -n 200 build.log || true
            exit 1
          fi
          echo "functions/lib/index.js exists"
          echo "Listing functions/lib contents:" && ls -la "$GITHUB_WORKSPACE/functions/lib" || true
          echo "Build log (last 50 lines):" && tail -n 50 build.log || true

      - name: Run rules tests in emulator
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "Node: $(node --version)"; echo "npm: $(npm --version)"
          echo "Listing functions bin:"; ls -la "$GITHUB_WORKSPACE/functions/node_modules/.bin" || true
          npx firebase emulators:exec --only firestore "bash -lc 'cd \"$GITHUB_WORKSPACE/functions\" && npm run test:rules'"

      - name: Run Functions unit tests in emulator
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "Node: $(node --version)"; echo "npm: $(npm --version)"
          echo "Listing functions bin:"; ls -la "$GITHUB_WORKSPACE/functions/node_modules/.bin" || true
          npx firebase emulators:exec --only functions,firestore "bash -lc 'cd \"$GITHUB_WORKSPACE/functions\" && npm run test:functions'"

      - name: Upload Functions npm logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: functions-npm-logs
          path: |
            functions/npm-ci.log
            functions/npm-install.log
            functions/build.log

      - name: Upload Functions build output (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: functions-build-output
          path: |
            functions/lib/**

      - name: Upload Firebase emulator logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: firebase-emulator-logs
          path: |
            firebase-debug.log
            firestore-debug.log
            functions/firebase-debug.log

